# Nome do Workflow
name: DevOpsLab Pipeline

# Evento que irá acionar a pipeline
on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      # Baixar o repositório
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Configurar o Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # Instalar dependências
      - name: Install Requirements
        run: pip install -r requirements.txt

      # Executar testes unitários
      - name: Run Unit Tests
        run: python -m unittest discover -v

      # Fazer login no Google Artifact Registry
      - name: Login to Google Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.GOOGLE_ARTIFACT }}
          username: _json_key
          password: ${{ secrets.GOOGLE_CREDENTIALS }}

      # Configurar o Buildx (para builds avançados, como multi-plataforma)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Construir a imagem Docker
      - name: Build Docker Image
        run: |
          IMAGE_NAME=${{ vars.GOOGLE_ARTIFACT }}/${{ vars.GOOGLE_PROJECT_ID }}/${{ vars.GOOGLE_REPONAME }}/${{ vars.GOOGLE_MYAPP }}:latest
          docker buildx build --no-cache -t $IMAGE_NAME .

      # Fazer push da imagem Docker
      - name: Push Docker Image
        run: |
          IMAGE_NAME=${{ vars.GOOGLE_ARTIFACT }}/${{ vars.GOOGLE_PROJECT_ID }}/${{ vars.GOOGLE_REPONAME }}/${{ vars.GOOGLE_MYAPP }}:latest
          docker push $IMAGE_NAME
